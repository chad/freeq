<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>freeq Policy & Authority Framework — Demo Walkthrough — freeq</title>
  <style>
    :root { --bg: #0c0c0f; --fg: #e4e4e7; --fg-dim: #71717a; --accent: #818cf8; --surface: #18181b; --border: #27272a; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--fg); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; line-height: 1.7; }
    .container { max-width: 800px; margin: 0 auto; padding: 2rem 1.5rem 4rem; }
    .nav { display: flex; align-items: center; gap: 1rem; padding: 1rem 0 2rem; border-bottom: 1px solid var(--border); margin-bottom: 2rem; }
    .nav a { color: var(--accent); text-decoration: none; font-size: 14px; }
    .nav a:hover { text-decoration: underline; }
    .nav .brand { font-weight: 700; font-size: 18px; color: var(--accent); }
    h1 { font-size: 2rem; margin: 0 0 1rem; color: var(--fg); }
    h2 { font-size: 1.4rem; margin: 2rem 0 0.75rem; color: var(--fg); border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
    h3 { font-size: 1.1rem; margin: 1.5rem 0 0.5rem; color: var(--fg); }
    p { margin: 0.75rem 0; }
    a { color: var(--accent); }
    code { background: var(--surface); padding: 0.15em 0.4em; border-radius: 4px; font-size: 0.9em; font-family: 'SF Mono', 'Fira Code', monospace; }
    pre { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; overflow-x: auto; margin: 1rem 0; }
    pre code { background: none; padding: 0; font-size: 0.85em; }
    table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    th, td { text-align: left; padding: 0.5rem 0.75rem; border: 1px solid var(--border); }
    th { background: var(--surface); font-weight: 600; }
    ul, ol { padding-left: 1.5rem; margin: 0.5rem 0; }
    li { margin: 0.25rem 0; }
    blockquote { border-left: 3px solid var(--accent); padding-left: 1rem; color: var(--fg-dim); margin: 1rem 0; }
    hr { border: none; border-top: 1px solid var(--border); margin: 2rem 0; }
    strong { color: #fff; }
    img { max-width: 100%; }
  </style>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <span class="brand">freeq</span>
      <a href="/">← Back to app</a>
      <a href="/docs/">All docs</a>
    </nav>
    <h1>freeq Policy &amp; Authority Framework — Demo Walkthrough</h1>
<p>This demonstrates freeq&#39;s cryptographic channel governance: policy-gated channels with auditable membership, built on standard IRC.</p>
<h2>Prerequisites</h2>
<ul>
<li>freeq server binary (<code>cargo build --release --bin freeq-server</code>)</li>
<li>A Bluesky account (for authenticated demo)</li>
<li>Any IRC client (for guest demo)</li>
<li><code>curl</code> and <code>python3</code> (for API inspection)</li>
</ul>
<h2>Quick Start</h2>
<pre><code class="language-bash"># Terminal 1: Start server
cargo run --release --bin freeq-server -- \
  --listen-addr 127.0.0.1:16799 \
  --web-addr 127.0.0.1:8080

# Terminal 2: Run interactive demo
./scripts/demo.sh
</code></pre>
<p>The demo script walks you through each scene with pauses. Or follow the manual steps below.</p>
<hr>
<h2>Manual Walkthrough</h2>
<h3>1. Connect a Guest (Standard IRC Client)</h3>
<p>Any IRC client works. Using netcat to prove the point:</p>
<pre><code>$ nc 127.0.0.1 16799
NICK guest42
USER guest 0 * :Guest
JOIN #general
PRIVMSG #general :Hello from a standard IRC client!
</code></pre>
<p>This works. Always will. Policy framework doesn&#39;t break existing IRC.</p>
<h3>2. Connect an Authenticated User</h3>
<p>Open the web client at <code>http://127.0.0.1:8080</code>:</p>
<ol>
<li>Click &quot;Sign in with Bluesky&quot;</li>
<li>Complete OAuth flow</li>
<li>You&#39;re now authenticated with your AT Protocol DID</li>
</ol>
<p>Or use the TUI client with SASL.</p>
<h3>3. Create a Channel and Set a Policy</h3>
<p>As the authenticated user (who&#39;ll be channel op):</p>
<pre><code>/join #freeq-dev
</code></pre>
<p>You&#39;re the founder — you have ops. Now set a policy:</p>
<pre><code>/POLICY #freeq-dev SET By joining this channel you agree to the freeq Code of Conduct: be respectful, no spam, no harassment. Violations result in removal.
</code></pre>
<p>Response:</p>
<pre><code>Policy set for #freeq-dev (version 1, rules_hash=a1b2c3d4e5f6, policy_id=d4e5f6789abc)
</code></pre>
<p>You&#39;re auto-attested (the op who created the policy is always accepted).</p>
<h3>4. Guest Tries to Join — Rejected</h3>
<p>The guest user tries:</p>
<pre><code>JOIN #freeq-dev
</code></pre>
<p>Response:</p>
<pre><code>477 guest42 #freeq-dev :This channel requires authentication — sign in to join
</code></pre>
<p>Clean rejection. The guest can still use <code>#general</code> and any other open channel.</p>
<h3>5. Second Authenticated User Accepts Policy</h3>
<p>A second user signs in with Bluesky, then:</p>
<pre><code>/POLICY #freeq-dev INFO
</code></pre>
<p>Response:</p>
<pre><code>Policy for #freeq-dev:
  Version: 1
  Policy ID: d4e5f6789abc...
  Effective: 2026-02-18T15:55:32+00:00
  Validity: JoinTime
  Requirement: ACCEPT(a1b2c3d4e5f6...)
</code></pre>
<p>Accept the policy:</p>
<pre><code>/POLICY #freeq-dev ACCEPT
</code></pre>
<p>Response:</p>
<pre><code>Policy accepted for #freeq-dev — role: member. You may now JOIN.
</code></pre>
<p>Now join:</p>
<pre><code>/join #freeq-dev
</code></pre>
<p>Success. They&#39;re in with a verified badge.</p>
<h3>6. Inspect the Audit Trail</h3>
<p><strong>Current policy:</strong></p>
<pre><code class="language-bash">curl -s http://127.0.0.1:8080/api/v1/policy/%23freeq-dev | python3 -m json.tool
</code></pre>
<pre><code class="language-json">{
    &quot;policy&quot;: {
        &quot;channel_id&quot;: &quot;#freeq-dev&quot;,
        &quot;policy_id&quot;: &quot;d4e5f6...&quot;,
        &quot;version&quot;: 1,
        &quot;effective_at&quot;: &quot;2026-02-18T15:55:32.123456+00:00&quot;,
        &quot;authority_set_hash&quot;: &quot;abc123...&quot;,
        &quot;requirements&quot;: {
            &quot;type&quot;: &quot;ACCEPT&quot;,
            &quot;hash&quot;: &quot;a1b2c3...&quot;
        },
        &quot;validity_model&quot;: &quot;join_time&quot;,
        &quot;receipt_embedding&quot;: &quot;require&quot;
    },
    &quot;authority_set&quot;: {
        &quot;channel_id&quot;: &quot;#freeq-dev&quot;,
        &quot;signers&quot;: [{&quot;did&quot;: &quot;did:web:127.0.0.1&quot;, ...}],
        &quot;policy_threshold&quot;: 1
    }
}
</code></pre>
<p><strong>Transparency log (privacy-preserving — no DIDs):</strong></p>
<pre><code class="language-bash">curl -s http://127.0.0.1:8080/api/v1/policy/%23freeq-dev/transparency | python3 -m json.tool
</code></pre>
<pre><code class="language-json">[
    {
        &quot;entry_version&quot;: 1,
        &quot;channel_id&quot;: &quot;#freeq-dev&quot;,
        &quot;policy_id&quot;: &quot;d4e5f6...&quot;,
        &quot;attestation_hash&quot;: &quot;789abc...&quot;,
        &quot;issued_at&quot;: &quot;2026-02-18T15:56:01.000000+00:00&quot;,
        &quot;issuer_authority_id&quot;: &quot;did:web:127.0.0.1&quot;
    }
]
</code></pre>
<p><strong>Check specific membership:</strong></p>
<pre><code class="language-bash">curl -s http://127.0.0.1:8080/api/v1/policy/%23freeq-dev/membership/did:plc:abc123 | python3 -m json.tool
</code></pre>
<p><strong>Policy version history:</strong></p>
<pre><code class="language-bash">curl -s http://127.0.0.1:8080/api/v1/policy/%23freeq-dev/history | python3 -m json.tool
</code></pre>
<h3>7. Update the Policy</h3>
<pre><code>/POLICY #freeq-dev SET Updated Code of Conduct v2: be respectful, no spam, no harassment, no AI-generated content without disclosure.
</code></pre>
<p>This creates version 2, chained to version 1. Existing members keep their attestations (JoinTime model). New joiners must accept v2.</p>
<h3>8. Remove the Policy</h3>
<pre><code>/POLICY #freeq-dev CLEAR
</code></pre>
<p>Channel returns to open join. All attestations and logs are removed.</p>
<hr>
<h2>Use Cases</h2>
<h3>Open Source Project Governance</h3>
<pre><code>POLICY #myproject SET &lt;Code of Conduct text&gt;
</code></pre>
<ul>
<li>Contributors accept CoC on join</li>
<li>Audit trail proves CoC was in place when incident occurred</li>
<li>Policy updates create version chain — full history preserved</li>
</ul>
<h3>Role-Based Access via GitHub Org Membership</h3>
<p>This is a full working example. A project channel where accepting the Code of Conduct gets you in, but GitHub org members automatically get ops.</p>
<p><strong>Step 1: Create the channel and set base policy</strong></p>
<pre><code>/join #myproject
/POLICY #myproject SET By contributing to this project you agree to our Code of Conduct: be respectful, inclusive, and constructive.
</code></pre>
<p><strong>Step 2: Add role escalation — org members get ops</strong></p>
<p>First, get the rules hash from POLICY INFO:</p>
<pre><code>/POLICY #myproject INFO
→ Requirement: ACCEPT(a1b2c3d4e5f6...)
</code></pre>
<p>Then set the &quot;op&quot; role requirement (replace the hash):</p>
<pre><code>/POLICY #myproject SET-ROLE op {&quot;type&quot;:&quot;ALL&quot;,&quot;requirements&quot;:[{&quot;type&quot;:&quot;ACCEPT&quot;,&quot;hash&quot;:&quot;a1b2c3d4e5f6...full-hash...&quot;},{&quot;type&quot;:&quot;PRESENT&quot;,&quot;credential_type&quot;:&quot;github_membership&quot;,&quot;issuer&quot;:&quot;github&quot;}]}
</code></pre>
<p><strong>Step 3: A contributor verifies their GitHub identity</strong></p>
<p>With GitHub OAuth configured (<code>GITHUB_CLIENT_ID</code> + <code>GITHUB_CLIENT_SECRET</code>):</p>
<pre><code>/POLICY #myproject VERIFY github myorg
→ Open this URL to verify your GitHub identity: http://127.0.0.1:8080/auth/github?did=...&amp;org=myorg
</code></pre>
<p>Click the link → GitHub OAuth → authenticate → server confirms org membership → credential stored. <strong>The server knows your real GitHub username from the OAuth token — no self-attestation possible.</strong></p>
<p>Without GitHub OAuth (public API fallback — weaker):</p>
<pre><code>/POLICY #myproject VERIFY github myorg octocat
→ ⚠ Note: public API check cannot prove you own this GitHub account
→ ✓ octocat is a public member of myorg. Credential stored (⚠ not OAuth-verified).
</code></pre>
<p><strong>Step 4: The contributor accepts the policy</strong></p>
<pre><code>/POLICY #myproject ACCEPT
→ Policy accepted for #myproject — role: op. You may now JOIN.
</code></pre>
<p>They got <code>op</code> because they have both the CoC acceptance AND the GitHub credential.</p>
<p><strong>Step 5: Join — auto +o</strong></p>
<pre><code>/join #myproject
→ (joined with +o automatically)
</code></pre>
<p>A user without GitHub membership who accepts the same policy gets <code>member</code> role — no ops, but they can chat.</p>
<p><strong>API alternative (for web/mobile):</strong></p>
<pre><code class="language-bash"># Verify GitHub membership
curl -X POST http://localhost:8080/api/v1/verify/github \
  -H &#39;Content-Type: application/json&#39; \
  -d &#39;{&quot;did&quot;:&quot;did:plc:abc123&quot;,&quot;github_username&quot;:&quot;octocat&quot;,&quot;org&quot;:&quot;myorg&quot;}&#39;

# Check stored credentials
curl http://localhost:8080/api/v1/credentials/did:plc:abc123

# Submit join with evidence
curl -X POST http://localhost:8080/api/v1/policy/%23myproject/join \
  -H &#39;Content-Type: application/json&#39; \
  -d &#39;{&quot;subject_did&quot;:&quot;did:plc:abc123&quot;,&quot;accepted_hashes&quot;:[&quot;a1b2c3...&quot;],&quot;credentials&quot;:[{&quot;credential_type&quot;:&quot;github_membership&quot;,&quot;issuer&quot;:&quot;github&quot;}]}&#39;
</code></pre>
<ul>
<li>Regular users who accept CoC → <code>member</code> role</li>
<li>GitHub org members who accept CoC → <code>op</code> role → automatic +o on join</li>
<li>No manual op management needed</li>
</ul>
<h3>Invite-Only Communities</h3>
<pre><code>POLICY #private SET PRESENT(invitation, issuer=did:plc:channelowner)
</code></pre>
<ul>
<li>Only users with an invitation credential from the owner can join</li>
<li>Invitation issuance is a separate step (via API)</li>
</ul>
<h3>Token-Gated Channels</h3>
<pre><code>POLICY #holders SET PROVE(nft_ownership)
</code></pre>
<ul>
<li>Users must prove ownership of a specific token</li>
<li>Proof verification is pluggable</li>
</ul>
<h3>Company Channels</h3>
<pre><code>POLICY #acme-eng SET ALL(ACCEPT(employee_handbook), PRESENT(email_verified, issuer=acme.com))
</code></pre>
<ul>
<li>Must accept employee handbook AND have verified @acme.com email</li>
<li>Policy changes cascade to S2S peers</li>
</ul>
<hr>
<h2>Architecture Notes</h2>
<h3>What happens at each layer</h3>
<table>
<thead>
<tr>
<th>Action</th>
<th>IRC Layer</th>
<th>Policy Layer</th>
<th>Crypto Layer</th>
</tr>
</thead>
<tbody><tr>
<td><code>/POLICY SET</code></td>
<td>NOTICE reply</td>
<td>PolicyDocument created, versioned</td>
<td>SHA-256 hash chain</td>
</tr>
<tr>
<td><code>/POLICY ACCEPT</code></td>
<td>NOTICE reply</td>
<td>Evidence evaluated, JoinReceipt + MembershipAttestation created</td>
<td>HMAC-SHA256 signed attestation</td>
</tr>
<tr>
<td><code>JOIN #channel</code></td>
<td>Standard JOIN flow</td>
<td>Attestation checked (or skipped if no policy)</td>
<td>Signature verified</td>
</tr>
<tr>
<td>Policy update</td>
<td>NOTICE reply</td>
<td>New version chained to previous</td>
<td>Hash chain integrity</td>
</tr>
<tr>
<td>S2S sync</td>
<td>—</td>
<td>PolicySync message to peers</td>
<td>Attestation signatures portable</td>
</tr>
</tbody></table>
<h3>Requirement DSL</h3>
<pre><code>ACCEPT { hash }              — User accepted rules document
PRESENT { type, issuer }     — User has credential of type from issuer
PROVE { proof_type }         — User can prove capability
ALL { requirements[] }       — All must be satisfied
ANY { requirements[] }       — At least one must be satisfied
NOT { requirement }          — Must NOT be satisfied
</code></pre>
<p>Max depth: 8. Max nodes: 64. Deterministic, fail-closed.</p>
<h3>Validity Models</h3>
<ul>
<li><strong>JoinTime</strong> — Evaluate once at join. Attestation never expires.</li>
<li><strong>Continuous</strong> — Attestation expires (default: 1 hour). Background task revalidates.</li>
</ul>
<h3>Privacy</h3>
<ul>
<li>Transparency log entries contain <strong>attestation hashes</strong>, not DIDs</li>
<li>Membership checks require knowing the specific DID to query</li>
<li>Log proves <em>that</em> attestations were issued, not <em>to whom</em></li>
</ul>
<hr>
<h2>HTTP API Reference</h2>
<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td><code>/api/v1/policy/{channel}</code></td>
<td>Current policy + authority set</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/v1/policy/{channel}/history</code></td>
<td>Full policy version chain</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/v1/policy/{channel}/join</code></td>
<td>Submit evidence, receive attestation</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/v1/policy/{channel}/membership/{did}</code></td>
<td>Check membership status</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/v1/policy/{channel}/transparency</code></td>
<td>Audit log entries</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/v1/authority/{hash}</code></td>
<td>Authority set by hash</td>
</tr>
</tbody></table>
<h3>POST /api/v1/policy/{channel}/join</h3>
<pre><code class="language-json">{
    &quot;subject_did&quot;: &quot;did:plc:abc123&quot;,
    &quot;accepted_hashes&quot;: [&quot;a1b2c3...&quot;],
    &quot;credentials&quot;: [
        {&quot;credential_type&quot;: &quot;github_membership&quot;, &quot;issuer&quot;: &quot;github&quot;}
    ],
    &quot;proofs&quot;: [&quot;nft_ownership_proof&quot;]
}
</code></pre>
<p>Response (success):</p>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;confirmed&quot;,
    &quot;join_id&quot;: &quot;deadbeef...&quot;,
    &quot;attestation&quot;: {
        &quot;attestation_id&quot;: &quot;...&quot;,
        &quot;channel_id&quot;: &quot;#freeq-dev&quot;,
        &quot;subject_did&quot;: &quot;did:plc:abc123&quot;,
        &quot;role&quot;: &quot;member&quot;,
        &quot;issued_at&quot;: &quot;2026-02-18T15:56:01Z&quot;,
        &quot;signature&quot;: &quot;hmac-sha256:...&quot;
    }
}
</code></pre>
<p>Response (rejected):</p>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;failed&quot;,
    &quot;error&quot;: &quot;Requirement not satisfied: ACCEPT(a1b2c3...)&quot;
}
</code></pre>
  </div>
</body>
</html>
